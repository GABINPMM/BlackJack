<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ROYAL BLACKJACK - Ultimate Mobile</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Oswald:wght@500&family=Roboto:wght@400;700&display=swap');

        :root {
            /* Palette Luxe Sombre */
            --bg-dark: #050505;
            --felt-gradient: radial-gradient(circle at 50% 30%, #1a472a, #0b2e19 60%, #000000);
            --gold: #d4af37;
            --gold-glow: #f9d765;
            --danger: #ff4757;
            --success: #2ed573;
            --action: #3742fa;
            
            /* Dimensions dynamiques */
            --card-w-big: 22vw;
            --card-h-big: 30vw;
            --card-w-mini: 10vw;
            --card-h-mini: 14vw;
            --chip-size: 16vw;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; height: 100vh; height: 100dvh;
            background: var(--bg-dark);
            font-family: 'Roboto', sans-serif; overflow: hidden;
            color: white; display: flex; flex-direction: column;
        }

        /* --- LOGIN SCREEN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 9999; padding: 30px;
        }
        .brand-title {
            font-family: 'Playfair Display', serif; font-size: 3rem; color: var(--gold);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3); margin-bottom: 40px; text-align: center;
        }
        .login-input {
            width: 100%; max-width: 320px; background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2); border-radius: 12px;
            padding: 18px; color: white; font-size: 1.1rem; margin-bottom: 15px;
            outline: none; transition: 0.3s; text-align: center;
        }
        .login-input:focus { border-color: var(--gold); background: rgba(0,0,0,0.5); }
        .btn-start {
            background: linear-gradient(135deg, var(--gold), #8f7218);
            color: black; border: none; padding: 20px 50px; border-radius: 50px;
            font-weight: bold; font-size: 1.2rem; margin-top: 20px;
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
            text-transform: uppercase; letter-spacing: 2px;
        }

        /* --- GAME LAYOUT --- */
        #game-table {
            flex: 1; background: var(--felt-gradient);
            position: relative; display: none; flex-direction: column;
        }

        /* --- TOP BAR (DEALER + INFO) --- */
        .top-bar {
            height: 25vh; position: relative; width: 100%;
            display: flex; justify-content: center; align-items: flex-start;
            padding-top: 10px;
        }
        
        /* Dealer Cards Center */
        .dealer-container {
            display: flex; flex-direction: column; align-items: center;
            transform: scale(0.85); transform-origin: top center;
        }

        /* --- OPPONENT (CORNER MINI VIEW) --- */
        .opponent-mini {
            position: absolute; top: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.6);
            padding: 5px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center;
            transform-origin: top right;
            backdrop-filter: blur(5px);
            max-width: 120px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .opponent-name { font-size: 0.7rem; color: #aaa; margin-bottom: 2px; }
        .opponent-cards-row { display: flex; height: var(--card-h-mini); }
        .opponent-cards-row .card { width: var(--card-w-mini); height: var(--card-h-mini); margin-left: -6vw; border-radius: 3px; font-size: 0.6rem;}
        .opponent-cards-row .card:first-child { margin-left: 0; }
        
        /* Host View for Seat 0/1 (Balanced) */
        .host-seat-view {
             /* Specific styling if host wants to see players differently, 
                but here we reuse opponent-mini logic or main player logic dynamically */
        }

        /* --- MAIN PLAYER (HERO AREA) --- */
        .hero-player {
            flex: 1; display: flex; flex-direction: column; 
            justify-content: flex-end; align-items: center;
            padding-bottom: 110px; /* Space for controls */
            position: relative;
        }
        
        .hero-info {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
            background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
            border: 1px solid rgba(255,215,0,0.3);
        }
        .hero-bank { color: var(--gold); font-family: 'Oswald', sans-serif; font-size: 1.2rem; }
        
        .hero-cards-container {
            display: flex; justify-content: center; align-items: flex-end;
            height: var(--card-h-big); width: 100%;
            perspective: 1000px; margin-bottom: 20px;
        }

        /* --- CARDS --- */
        .card {
            background: white; border-radius: 6px; color: black;
            display: flex; flex-direction: column; justify-content: space-between; padding: 4px;
            font-weight: bold; box-shadow: 2px 2px 8px rgba(0,0,0,0.5);
            position: relative; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .hero-cards-container .card {
            width: var(--card-w-big); height: var(--card-h-big);
            margin-left: -12vw; /* Overlap Big */
            font-size: 1.5rem;
            border-radius: 8px;
        }
        .hero-cards-container .card:first-child { margin-left: 0; }
        
        /* Split layout adjustment */
        .split-layout .cards-wrapper { transform: scale(0.85); margin: 0 5px; }
        .hero-cards-container.split-mode { align-items: center; }

        .card.red { color: #c0392b; }
        .card.black { color: #2c3e50; }
        .card.back { 
            background: repeating-linear-gradient(45deg, #2c3e50, #2c3e50 5px, #34495e 5px, #34495e 10px);
            border: 2px solid white;
        }
        .card.back * { display: none; }
        .suit-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5em; opacity: 0.8; }
        
        .score-badge {
            position: absolute; top: -15px; right: -5px;
            background: var(--gold); color: black; font-weight: bold;
            padding: 2px 8px; border-radius: 10px; font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 50;
        }

        /* --- CONTROLS --- */
        .controls-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 15px 15px 30px 15px; /* Safe area padding */
            background: linear-gradient(to top, rgba(0,0,0,1), rgba(0,0,0,0.8));
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
            z-index: 100; border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .ctrl-btn {
            background: #333; color: white; border: none;
            padding: 18px 0; border-radius: 12px;
            font-family: 'Oswald', sans-serif; font-size: 1.1rem; letter-spacing: 1px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            transition: all 0.1s; opacity: 0.3; pointer-events: none;
        }
        .ctrl-btn.active { opacity: 1; pointer-events: all; }
        .ctrl-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-hit { background: var(--success); color: #000; grid-column: span 1; }
        .btn-stand { background: var(--danger); color: white; grid-column: span 1; }
        .btn-double { background: var(--gold); color: black; grid-column: span 1; }
        .btn-split { background: var(--action); color: white; grid-column: span 1; }
        
        .btn-deal { 
            grid-column: span 4; background: linear-gradient(90deg, var(--gold), #fff5c3, var(--gold));
            color: black; font-size: 1.3rem; animation: shine 3s infinite;
        }

        /* --- CHIPS DRAWER --- */
        .betting-overlay {
            position: absolute; bottom: 120px; width: 100%;
            display: flex; justify-content: center; align-items: flex-end; gap: 10px;
            transition: 0.4s; transform: translateY(200px); opacity: 0; pointer-events: none;
        }
        .betting-overlay.show { transform: translateY(0); opacity: 1; pointer-events: all; }
        
        .chip {
            width: var(--chip-size); height: var(--chip-size);
            border-radius: 50%; border: 3px dashed rgba(255,255,255,0.5);
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-family: 'Oswald', sans-serif;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            background-size: cover; cursor: pointer;
        }
        .chip:active { transform: scale(0.9); }
        .chip-10 { background: #e74c3c; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .chip-50 { background: #3498db; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .chip-100 { background: #2ecc71; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .chip-500 { background: #34495e; border-color: var(--gold); color: var(--gold); }
        
        .bet-display {
            position: absolute; bottom: 20%; left: 50%; transform: translateX(-50%);
            font-size: 1.5rem; color: var(--gold); font-family: 'Oswald', sans-serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        /* --- MESSAGES --- */
        #status-toast {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 15px 30px;
            border-radius: 50px; border: 1px solid var(--gold);
            font-size: 1.5rem; text-align: center; font-family: 'Oswald', sans-serif;
            opacity: 0; pointer-events: none; transition: 0.3s; width: 80%;
            z-index: 500; backdrop-filter: blur(5px);
        }
        #status-toast.visible { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }

    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="brand-title">ROYAL<br><span style="font-size:1.5rem; color:white; letter-spacing:5px;">BLACKJACK</span></div>
        <input type="text" id="room-input" class="login-input" placeholder="ID Salon (ex: VIP)" value="VIP">
        <input type="text" id="user-input" class="login-input" placeholder="Votre Pseudo">
        <input type="number" id="bank-input" class="login-input" value="1000" placeholder="Bankroll">
        <button class="btn-start" onclick="initLogin()">ENTRER</button>
        <div id="conn-log" style="color:#666; margin-top:20px; font-size:0.8rem;">Prêt à jouer</div>
    </div>

    <!-- GAME TABLE -->
    <div id="game-table">
        
        <!-- TOP: DEALER & OPPONENT -->
        <div class="top-bar">
            <!-- Dealer -->
            <div class="dealer-container">
                <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">CROUPIER</div>
                <div id="dealer-hand" class="hero-cards-container" style="height:var(--card-h-mini);"></div>
                <div id="dealer-score" class="score-badge" style="display:none;">0</div>
            </div>

            <!-- OPPONENT (Mini View) -->
            <div id="opponent-view" class="opponent-mini" style="display:none;">
                <div id="opp-name" class="opponent-name">Adversaire</div>
                <div id="opp-hand" class="opponent-cards-row"></div>
                <div id="opp-score" style="position:absolute; bottom:-10px; right:-5px; background:grey; font-size:0.6rem; padding:2px 5px; border-radius:4px;">0</div>
            </div>
        </div>

        <!-- CENTER MESSAGE -->
        <div id="status-toast">MESSAGE</div>

        <!-- BOTTOM: HERO PLAYER -->
        <div class="hero-player">
            <!-- Bet Display on table -->
            <div class="bet-display" id="my-bet-display"></div>

            <div class="hero-cards-container" id="my-hand-container">
                <!-- Cards injected here -->
            </div>

            <div class="hero-info">
                <span id="my-name">Moi</span>
                <span style="color:#555">|</span>
                <span class="hero-bank">$<span id="my-bank">0</span></span>
            </div>
        </div>

        <!-- CHIPS DRAWER -->
        <div id="chip-drawer" class="betting-overlay">
            <div class="chip" style="background:#333; font-size:1.5rem; color:red; border-color:red;" onclick="placeBet(-1)">×</div>
            <div class="chip chip-10" onclick="placeBet(10)">10</div>
            <div class="chip chip-50" onclick="placeBet(50)">50</div>
            <div class="chip chip-100" onclick="placeBet(100)">100</div>
            <div class="chip chip-500" onclick="placeBet(500)">500</div>
            <div class="chip" style="background:var(--gold); border-color:white; color:black;" onclick="validateBet()">OK</div>
        </div>

        <!-- CONTROLS -->
        <div class="controls-bar">
            <button id="btn-hit" class="ctrl-btn btn-hit" onclick="clientAction('HIT')">TIRE</button>
            <button id="btn-stand" class="ctrl-btn btn-stand" onclick="clientAction('STAND')">RESTE</button>
            <button id="btn-double" class="ctrl-btn btn-double" onclick="clientAction('DOUBLE')">DOUBLE</button>
            <button id="btn-split" class="ctrl-btn btn-split" onclick="clientAction('SPLIT')">SPLIT</button>
            
            <!-- Host Button (Overlays others if active) -->
            <button id="btn-deal" class="ctrl-btn btn-deal" style="display:none;" onclick="hostDeal()">DISTRIBUER</button>
            <button id="btn-open" class="ctrl-btn btn-deal" style="display:none;" onclick="hostOpenTable()">OUVRIR LA TABLE</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const SUITS = ['♠', '♥', '♣', '♦'];
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        const peerConfig = {
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] }
        };

        let peer, hostConn, playerConnections = [null, null];
        let myRole = null, mySeatIndex = -1;
        let localBetDraft = 0;

        let gameState = {
            phase: 'lobby',
            activePlayerIndex: 0,
            activeHandSubIndex: 0,
            deck: [],
            dealer: { hand: [], score: 0 },
            players: [
                { id: null, name: null, hand: [], score: 0, bankroll: 0, bet: 0, status: 'empty', splitHand: null, splitScore:0, splitBet:0 },
                { id: null, name: null, hand: [], score: 0, bankroll: 0, bet: 0, status: 'empty', splitHand: null, splitScore:0, splitBet:0 }
            ]
        };

        // --- DOM REFS ---
        const ui = {
            login: document.getElementById('login-overlay'),
            table: document.getElementById('game-table'),
            status: document.getElementById('status-toast'),
            chips: document.getElementById('chip-drawer'),
            dealerHand: document.getElementById('dealer-hand'),
            myHand: document.getElementById('my-hand-container'),
            oppView: document.getElementById('opponent-view'),
            oppHand: document.getElementById('opp-hand'),
            btns: {
                hit: document.getElementById('btn-hit'),
                stand: document.getElementById('btn-stand'),
                double: document.getElementById('btn-double'),
                split: document.getElementById('btn-split'),
                deal: document.getElementById('btn-deal'),
                open: document.getElementById('btn-open')
            }
        };

        // --- CONNECTION LOGIC ---
        function initLogin() {
            const room = document.getElementById('room-input').value.trim();
            const user = document.getElementById('user-input').value.trim();
            const bank = parseInt(document.getElementById('bank-input').value) || 1000;
            if(!room || !user) return;

            const peerId = 'rbj_mobile_' + room.toLowerCase().replace(/[^a-z0-9]/g, '');
            document.getElementById('conn-log').innerText = "Connexion...";

            const p = new Peer(peerId, peerConfig);
            
            p.on('open', (id) => {
                myRole = 'HOST'; peer = p;
                startUI();
                setupHost();
            });
            p.on('error', (err) => {
                if(err.type === 'unavailable-id') joinClient(peerId, user, bank);
                else alert("Erreur: " + err.type);
            });
        }

        function joinClient(hostId, user, bank) {
            const p = new Peer(null, peerConfig);
            p.on('open', () => {
                myRole = 'CLIENT'; peer = p;
                hostConn = p.connect(hostId);
                hostConn.on('open', () => {
                    hostConn.send({ type: 'JOIN', name: user, bank: bank });
                    startUI();
                });
                hostConn.on('data', handleData);
                hostConn.on('close', () => location.reload());
            });
        }

        function startUI() {
            ui.login.style.display = 'none';
            ui.table.style.display = 'flex';
        }

        // --- HOST LOGIC ---
        function setupHost() {
            peer.on('connection', (conn) => {
                const idx = gameState.players.findIndex(p => p.status === 'empty');
                if(idx === -1) { setTimeout(() => conn.close(), 500); return; }

                conn.on('data', (data) => {
                    if(data.type === 'JOIN') {
                        gameState.players[idx] = { ...gameState.players[idx], id: conn.peer, name: data.name, bankroll: data.bank, status: 'joined' };
                        playerConnections[idx] = conn;
                        conn.send({ type: 'WELCOME', seat: idx });
                        broadcast();
                    }
                    if(data.type === 'BET' && gameState.phase === 'betting') {
                        gameState.players[idx].bet = data.amount;
                        gameState.players[idx].status = 'ready';
                        broadcast();
                    }
                    if(data.type === 'ACTION') handleAction(idx, data.act);
                });

                conn.on('close', () => {
                    gameState.players[idx] = { id:null, name:null, hand:[], score:0, bankroll:0, bet:0, status:'empty', splitHand:null };
                    playerConnections[idx] = null;
                    broadcast();
                });
            });
        }

        function hostOpenTable() {
            gameState.deck = createDeck();
            gameState.phase = 'betting';
            broadcast();
        }

        function hostDeal() {
            const active = gameState.players.filter(p => p.status !== 'empty');
            if(active.length > 0 && active.every(p => p.status === 'ready')) {
                gameState.players.forEach(p => {
                    if(p.status === 'ready') {
                        p.bankroll -= p.bet;
                        p.hand = [draw(), draw()];
                        p.score = calc(p.hand);
                        p.status = 'playing';
                        if(p.score === 21) p.status = 'blackjack';
                    }
                });
                gameState.dealer.hand = [draw(), draw()];
                gameState.dealer.score = calc(gameState.dealer.hand);
                
                gameState.phase = 'turn';
                gameState.activePlayerIndex = gameState.players.findIndex(p => p.status === 'playing');
                gameState.activeHandSubIndex = 0;
                
                if(gameState.activePlayerIndex === -1) { gameState.phase = 'dealer_turn'; runDealer(); }
                broadcast();
            }
        }

        function handleAction(idx, act) {
            if(gameState.phase !== 'turn' || gameState.activePlayerIndex !== idx) return;
            const p = gameState.players[idx];
            const isSplit = (gameState.activeHandSubIndex === 1);
            let hand = isSplit ? p.splitHand : p.hand;
            
            if(act === 'HIT') {
                hand.push(draw());
                if(isSplit) p.splitScore = calc(hand); else p.score = calc(hand);
                
                const sc = isSplit ? p.splitScore : p.score;
                if(sc > 21) {
                    if(isSplit) p.splitStatus = 'busted'; else p.status = 'busted'; // Fixed variable name
                    advance();
                }
            } else if(act === 'STAND') {
                if(isSplit) p.splitStatus = 'stand'; else p.status = 'stand'; // Fixed variable name
                advance();
            } else if(act === 'DOUBLE' && !isSplit && p.bankroll >= p.bet) {
                p.bankroll -= p.bet; p.bet *= 2;
                hand.push(draw());
                p.score = calc(hand);
                p.status = p.score > 21 ? 'busted' : 'stand';
                advance();
            } else if(act === 'SPLIT' && !isSplit && p.bankroll >= p.bet) {
                p.bankroll -= p.bet;
                p.splitBet = p.bet;
                p.splitHand = [p.hand.pop()];
                p.hand.push(draw());
                p.splitHand.push(draw());
                p.score = calc(p.hand);
                p.splitScore = calc(p.splitHand);
                p.splitStatus = 'playing';
                // Stay on main hand
            }
            broadcast();
        }

        function advance() {
            const p = gameState.players[gameState.activePlayerIndex];
            if(gameState.activeHandSubIndex === 0 && p.splitHand) {
                gameState.activeHandSubIndex = 1;
                return;
            }
            // Next player
            let next = -1;
            for(let i = gameState.activePlayerIndex + 1; i < 2; i++) {
                if(gameState.players[i].status === 'playing') { next = i; break; }
            }
            if(next !== -1) {
                gameState.activePlayerIndex = next;
                gameState.activeHandSubIndex = 0;
            } else {
                gameState.phase = 'dealer_turn';
                runDealer();
            }
        }

        function runDealer() {
            broadcast();
            const play = () => {
                if(gameState.dealer.score < 17) {
                    setTimeout(() => {
                        gameState.dealer.hand.push(draw());
                        gameState.dealer.score = calc(gameState.dealer.hand);
                        broadcast();
                        play();
                    }, 800);
                } else endRound();
            };
            setTimeout(play, 800);
        }

        function endRound() {
            gameState.phase = 'payout';
            const dSc = gameState.dealer.score > 21 ? 0 : gameState.dealer.score;
            
            gameState.players.forEach(p => {
                if(p.status === 'empty') return;
                const settle = (sc, bet, st) => {
                    let w = 0;
                    const cleanSc = sc > 21 ? 0 : sc;
                    if(st === 'blackjack') w = (gameState.dealer.hand.length===2 && dSc===21) ? bet : bet*2.5;
                    else if(st !== 'busted') {
                        if(cleanSc > dSc) w = bet*2;
                        else if(cleanSc === dSc) w = bet;
                    }
                    p.bankroll += w;
                };
                settle(p.score, p.bet, p.status);
                if(p.splitHand) settle(p.splitScore, p.splitBet, p.splitStatus);
            });
            broadcast();
            
            setTimeout(() => {
                gameState.phase = 'betting';
                gameState.players.forEach(p => {
                    if(p.status !== 'empty') {
                        p.hand = []; p.score=0; p.bet=0; p.status='joined'; p.splitHand=null;
                    }
                });
                gameState.dealer.hand = [];
                broadcast();
            }, 4000);
        }

        // --- CLIENT LOGIC ---
        function handleData(data) {
            if(data.type === 'WELCOME') mySeatIndex = data.seat;
            if(data.type === 'UPDATE') {
                gameState = data.state;
                if(gameState.phase === 'betting' && gameState.players[mySeatIndex].bet === 0) localBetDraft = 0;
                render();
            }
        }
        function clientAction(act) { hostConn.send({ type: 'ACTION', act: act }); }
        function placeBet(amt) {
            const p = gameState.players[mySeatIndex];
            if(amt === -1) localBetDraft = 0;
            else if(localBetDraft + amt <= p.bankroll) localBetDraft += amt;
            render();
        }
        function validateBet() {
            if(localBetDraft > 0) hostConn.send({ type: 'BET', amount: localBetDraft });
        }

        // --- SHARED ---
        function broadcast() {
            playerConnections.forEach(c => { if(c && c.open) c.send({ type: 'UPDATE', state: gameState }); });
            render();
        }
        function createDeck() {
            let d = [];
            SUITS.forEach(s => RANKS.forEach(r => d.push({r, s, val: (r==='A'?11 : (['J','Q','K'].includes(r)?10:parseInt(r))), color: (s==='♥'||s==='♦')?'red':'black' })));
            return d.sort(()=>Math.random()-0.5);
        }
        function draw() { return gameState.deck.pop(); }
        function calc(h) {
            let s=0, a=0; h.forEach(c=>{s+=c.val; if(c.r==='A')a++});
            while(s>21 && a>0){s-=10;a--} return s;
        }

        // --- RENDERER (THE MAGIC) ---
        function render() {
            // Toast Status
            const toast = ui.status;
            let msg = "";
            if(gameState.phase === 'lobby') msg = "ATTENTE DU JEU";
            if(gameState.phase === 'betting') msg = "FAITES VOS JEUX";
            if(gameState.phase === 'payout') msg = "RESULTATS";
            if(gameState.phase === 'turn') {
                const activeP = gameState.players[gameState.activePlayerIndex];
                if(gameState.activePlayerIndex === mySeatIndex) msg = "A TOI DE JOUER";
                else msg = `TOUR DE ${activeP.name}`;
            }
            if(msg) { toast.innerText = msg; toast.classList.add('visible'); }
            else toast.classList.remove('visible');

            // --- DEALER ---
            ui.dealerHand.innerHTML = '';
            gameState.dealer.hand.forEach((c, i) => {
                const hidden = (i===1 && (gameState.phase==='turn' || gameState.phase==='betting'));
                ui.dealerHand.appendChild(createCard(c, i, hidden, false));
            });
            document.getElementById('dealer-score').style.display = (gameState.dealer.hand.length > 0 && gameState.phase !== 'betting') ? 'block' : 'none';
            document.getElementById('dealer-score').innerText = gameState.dealer.score;

            // --- IDENTIFY ROLES ---
            let me = null, opp = null;
            if(myRole === 'CLIENT') {
                me = gameState.players[mySeatIndex];
                opp = gameState.players[mySeatIndex === 0 ? 1 : 0];
            } else {
                // Host View: Show Seat 0 as "Me" visually, Seat 1 as Opponent (for now)
                me = gameState.players[0];
                opp = gameState.players[1];
            }

            // --- MY HERO AREA ---
            ui.myHand.innerHTML = '';
            document.getElementById('my-name').innerText = me.name || 'Vide';
            document.getElementById('my-bank').innerText = me.bankroll;
            
            // Chips Drawer
            if(gameState.phase === 'betting' && me.status !== 'ready' && (myRole === 'CLIENT')) {
                ui.chips.classList.add('show');
                document.getElementById('my-bet-display').innerText = localBetDraft > 0 ? `$${localBetDraft}` : "MISE ?";
            } else {
                ui.chips.classList.remove('show');
                let displayBet = me.bet;
                if(me.splitBet > 0) displayBet += me.splitBet;
                document.getElementById('my-bet-display').innerText = displayBet > 0 ? `$${displayBet}` : "";
            }

            // Cards Main
            const myTurn = (gameState.phase === 'turn' && gameState.activePlayerIndex === (myRole==='CLIENT'?mySeatIndex:0));
            
            // Helper wrapper
            const wrap = document.createElement('div');
            wrap.className = `cards-wrapper ${me.splitHand ? 'split-mode' : ''}`;
            
            // Score Bubble
            if(me.hand.length>0) {
                const sb = document.createElement('div');
                sb.className = 'score-badge'; sb.innerText = me.score;
                wrap.appendChild(sb);
            }
            me.hand.forEach((c, i) => wrap.appendChild(createCard(c, i, false, true)));
            ui.myHand.appendChild(wrap);

            // Split Hand
            if(me.splitHand) {
                const wrapS = document.createElement('div');
                wrapS.className = 'cards-wrapper split-mode';
                if(myTurn && gameState.activeHandSubIndex === 1) wrapS.style.transform = "scale(1.1)"; // Highlight
                
                const sbS = document.createElement('div');
                sbS.className = 'score-badge'; sbS.innerText = me.splitScore;
                wrapS.appendChild(sbS);

                me.splitHand.forEach((c, i) => wrapS.appendChild(createCard(c, i, false, true)));
                ui.myHand.appendChild(wrapS);
            }

            // --- OPPONENT MINI ---
            ui.oppView.style.display = (opp && opp.status !== 'empty') ? 'flex' : 'none';
            if(opp && opp.status !== 'empty') {
                document.getElementById('opp-name').innerText = opp.name;
                ui.oppHand.innerHTML = '';
                opp.hand.forEach((c, i) => ui.oppHand.appendChild(createCard(c, i, false, false)));
                document.getElementById('opp-score').innerText = opp.score;
            }

            // --- CONTROLS ---
            Object.values(ui.btns).forEach(b => { b.style.display = 'none'; b.classList.remove('active'); });
            
            if(myRole === 'HOST') {
                ui.btns.open.style.display = 'block';
                ui.btns.deal.style.display = 'block';
                if(gameState.phase === 'lobby') ui.btns.open.classList.add('active');
                if(gameState.phase === 'betting') {
                   // Check readiness
                   const activeP = gameState.players.filter(p=>p.status!=='empty');
                   if(activeP.length > 0 && activeP.every(p=>p.status==='ready')) ui.btns.deal.classList.add('active');
                }
            } else if (myRole === 'CLIENT' && myTurn) {
                ['hit', 'stand', 'double', 'split'].forEach(k => { ui.btns[k].style.display = 'block'; ui.btns[k].classList.add('active'); });
                
                // Rule check
                const activeH = (gameState.activeHandSubIndex === 0) ? me.hand : me.splitHand;
                const activeBet = (gameState.activeHandSubIndex === 0) ? me.bet : me.splitBet;

                if(activeH.length !== 2 || me.bankroll < activeBet) ui.btns.double.classList.remove('active');
                if(gameState.activeHandSubIndex !== 0 || me.hand.length !== 2 || me.hand[0].r !== me.hand[1].r || me.splitHand || me.bankroll < me.bet) ui.btns.split.classList.remove('active');
            }
        }

        function createCard(c, i, hidden, big) {
            const el = document.createElement('div');
            el.className = `card ${c.color} ${hidden ? 'back' : ''}`;
            if(big && !hidden) {
                // Better styling for big cards
                el.innerHTML = `
                    <div style="font-size:1em; line-height:1;">${c.r}<br>${c.s}</div>
                    <div class="suit-center">${c.s}</div>
                    <div class="val-btm" style="font-size:1em; line-height:1;">${c.r}<br>${c.s}</div>
                `;
            } else if(!hidden) {
                el.innerHTML = `${c.r}${c.s}`;
            }
            return el;
        }

    </script>
</body>
</html>