<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ROYAL BLACKJACK - Ultimate Mobile V2</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Oswald:wght@500&family=Roboto:wght@400;700&display=swap');

        :root {
            --bg-dark: #050505;
            /* Un vert plus profond et luxueux */
            --felt-gradient: radial-gradient(circle at 50% 40%, #1e5e34, #0d3a20 70%, #02120a);
            --gold: #d4af37;
            --gold-glow: #f9d765;
            --danger: #ff4757;
            --success: #2ed573;
            --action: #3742fa;
            
            /* Ajustement des tailles pour éviter les coupures */
            --card-w-big: 20vw;
            --card-h-big: 28vw;
            --card-w-mini: 9vw;
            --card-h-mini: 12.6vw;
            --chip-size: 15vw;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; 
            height: 100vh; 
            height: 100dvh; /* Support complet mobile */
            background: var(--bg-dark);
            font-family: 'Roboto', sans-serif; overflow: hidden;
            color: white; display: flex; flex-direction: column;
        }

        /* --- LOGIN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 9999; padding: 30px;
        }
        .brand-title {
            font-family: 'Playfair Display', serif; font-size: 2.5rem; color: var(--gold);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.3); margin-bottom: 30px; text-align: center;
        }
        .login-input {
            width: 100%; max-width: 300px; background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
            padding: 15px; color: white; font-size: 1rem; margin-bottom: 12px;
            outline: none; transition: 0.3s; text-align: center;
        }
        .login-input:focus { border-color: var(--gold); background: rgba(0,0,0,0.5); }
        .btn-start {
            background: linear-gradient(135deg, var(--gold), #8f7218);
            color: black; border: none; padding: 18px 45px; border-radius: 50px;
            font-weight: bold; font-size: 1.1rem; margin-top: 15px;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.2);
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* --- GAME LAYOUT --- */
        #game-table {
            flex: 1; background: var(--felt-gradient);
            position: relative; display: none; flex-direction: column;
            padding-bottom: 90px; /* Espace pour les boutons */
        }

        /* --- TOP BAR (DEALER) --- */
        .top-bar {
            height: 22%; /* Zone définie pour le croupier */
            width: 100%;
            display: flex; justify-content: center; align-items: flex-end; /* Aligné en bas de la zone top */
            padding-bottom: 10px;
            position: relative;
            margin-top: env(safe-area-inset-top); /* Sécurité iPhone */
            padding-top: 20px; /* Marge de sécurité visuelle supplémentaire */
        }
        
        .dealer-container {
            display: flex; flex-direction: column; align-items: center;
            /* On s'assure que le croupier n'est pas trop gros */
            transform: scale(0.9); transform-origin: bottom center;
        }

        /* --- OPPONENT (Mini View - TOP RIGHT) --- */
        .opponent-mini {
            position: absolute; top: max(10px, env(safe-area-inset-top)); right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 6px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15);
            display: flex; flex-direction: column; align-items: center;
            backdrop-filter: blur(4px);
            z-index: 50;
        }
        .opponent-name { font-size: 0.65rem; color: #ccc; margin-bottom: 4px; font-weight: bold; text-transform: uppercase; }
        .opponent-cards-row { display: flex; height: var(--card-h-mini); }
        .opponent-cards-row .card { 
            width: var(--card-w-mini); height: var(--card-h-mini); 
            margin-left: -5vw; border-radius: 4px; font-size: 0.6rem;
        }
        .opponent-cards-row .card:first-child { margin-left: 0; }

        /* --- CENTER AREA (MESSAGE) --- */
        #status-toast {
            position: absolute; 
            top: 24%; /* Placé SOUS le croupier, pas sur le joueur */
            left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: var(--gold); 
            padding: 8px 20px;
            border-radius: 30px; border: 1px solid var(--gold);
            font-size: 1.1rem; text-align: center; font-family: 'Oswald', sans-serif;
            opacity: 0; pointer-events: none; transition: 0.3s; 
            white-space: nowrap; z-index: 40;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #status-toast.visible { opacity: 1; transform: translateX(-50%) scale(1.05); }

        /* --- HERO PLAYER (BOTTOM) --- */
        .hero-player {
            flex: 1; /* Prend tout l'espace restant */
            display: flex; flex-direction: column; 
            justify-content: center; /* Centre verticalement dans l'espace restant */
            align-items: center;
            position: relative;
        }
        
        /* Mise affichée AU-DESSUS des cartes pour ne pas gêner */
        .bet-display {
            font-size: 1.4rem; color: rgba(255,255,255,0.8); font-family: 'Oswald', sans-serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            margin-bottom: 10px; /* Espace avant les cartes */
            background: rgba(0,0,0,0.3); padding: 2px 10px; border-radius: 10px;
        }

        .hero-cards-container {
            display: flex; justify-content: center; align-items: center;
            /* CRITIQUE : flex-row pour éviter l'empilement vertical */
            flex-direction: row; 
            height: var(--card-h-big); width: 100%;
            perspective: 1000px; margin-bottom: 15px;
        }

        .hero-info {
            display: flex; align-items: center; gap: 10px; 
            background: linear-gradient(90deg, rgba(0,0,0,0), rgba(0,0,0,0.8), rgba(0,0,0,0));
            padding: 5px 30px;
            border-top: 1px solid rgba(255,215,0,0.2);
            margin-bottom: 5px;
        }
        .hero-bank { color: var(--success); font-family: 'Oswald', sans-serif; font-size: 1.2rem; font-weight: bold; }

        /* --- CARDS --- */
        .card {
            background: white; border-radius: 6px; color: black;
            display: flex; flex-direction: column; justify-content: space-between; padding: 4px;
            font-weight: bold; box-shadow: -2px 0 10px rgba(0,0,0,0.4);
            position: relative; transition: transform 0.3s ease-out;
        }
        .hero-cards-container .card {
            width: var(--card-w-big); height: var(--card-h-big);
            margin-left: -11vw; /* Chevauchement horizontal */
            font-size: 1.4rem;
            border-radius: 8px;
            /* S'assurer que les cartes ne rétrécissent pas */
            flex-shrink: 0; 
        }
        .hero-cards-container .card:first-child { margin-left: 0; }
        
        /* Mode Split */
        .hero-cards-container.split-mode .card { margin-left: -16vw; transform: scale(0.9); }
        
        .card.red { color: #c0392b; }
        .card.black { color: #2c3e50; }
        .card.back { 
            background: repeating-linear-gradient(45deg, #182C61, #182C61 5px, #1a3375 5px, #1a3375 10px);
            border: 2px solid #fff;
        }
        .card.back * { display: none; }
        .suit-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.2em; opacity: 0.8; }
        
        /* Bulle de score */
        .score-badge {
            position: absolute; top: -12px; right: -8px;
            background: var(--gold); color: black; font-weight: bold;
            padding: 2px 6px; border-radius: 8px; font-size: 0.85rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 60;
            border: 1px solid white;
        }

        /* --- CONTROLS --- */
        .controls-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 10px 10px max(15px, env(safe-area-inset-bottom)) 10px;
            background: rgba(0,0,0,0.95);
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            z-index: 100; border-top: 1px solid rgba(255,255,255,0.15);
        }
        
        .ctrl-btn {
            background: #333; color: white; border: none;
            padding: 15px 0; border-radius: 10px;
            font-family: 'Oswald', sans-serif; font-size: 1rem; letter-spacing: 0.5px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
            transition: all 0.1s; opacity: 0.3; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .ctrl-btn.active { opacity: 1; pointer-events: all; cursor: pointer; }
        .ctrl-btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* Couleurs Néon pour visibilité */
        .btn-hit { background: var(--success); color: #000; box-shadow: 0 4px 0 #1e8e4c; }
        .btn-stand { background: var(--danger); color: white; box-shadow: 0 4px 0 #c0392b; }
        .btn-double { background: var(--gold); color: black; box-shadow: 0 4px 0 #9e8228; }
        .btn-split { background: var(--action); color: white; box-shadow: 0 4px 0 #192a56; }
        
        .btn-deal { 
            grid-column: span 4; background: linear-gradient(90deg, var(--gold), #fff5c3, var(--gold));
            color: black; font-size: 1.2rem; animation: shine 3s infinite; box-shadow: 0 4px 0 #b8860b;
        }

        /* --- CHIPS DRAWER --- */
        .betting-overlay {
            position: absolute; bottom: 100px; width: 100%;
            display: flex; justify-content: center; align-items: flex-end; gap: 8px;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform: translateY(200px); opacity: 0; pointer-events: none;
            padding-bottom: 10px;
        }
        .betting-overlay.show { transform: translateY(0); opacity: 1; pointer-events: all; }
        
        .chip {
            width: var(--chip-size); height: var(--chip-size);
            border-radius: 50%; border: 3px dashed rgba(255,255,255,0.6);
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-family: 'Oswald', sans-serif; font-size: 0.9rem;
            box-shadow: 0 5px 10px rgba(0,0,0,0.6); cursor: pointer;
        }
        .chip:active { transform: scale(0.9); }
        .chip-10 { background: #e74c3c; }
        .chip-50 { background: #3498db; }
        .chip-100 { background: #2ecc71; }
        .chip-500 { background: #2c3e50; border-color: var(--gold); color: var(--gold); }
        
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="brand-title">ROYAL<br><span style="font-size:1.5rem; color:white; letter-spacing:5px;">BLACKJACK</span></div>
        <input type="text" id="room-input" class="login-input" placeholder="ID Salon (ex: VIP)" value="VIP">
        <input type="text" id="user-input" class="login-input" placeholder="Votre Pseudo">
        <input type="number" id="bank-input" class="login-input" value="1000" placeholder="Bankroll">
        <button class="btn-start" onclick="initLogin()">ENTRER</button>
        <div id="conn-log" style="color:#666; margin-top:20px; font-size:0.8rem;">Prêt à jouer</div>
    </div>

    <!-- GAME TABLE -->
    <div id="game-table">
        
        <!-- TOP: DEALER & OPPONENT -->
        <div class="top-bar">
            <!-- Dealer -->
            <div class="dealer-container">
                <div style="font-size:0.7rem; color:#888; margin-bottom:4px; letter-spacing: 1px;">CROUPIER</div>
                <!-- On force le flex row ici aussi -->
                <div id="dealer-hand" class="hero-cards-container" style="height:var(--card-h-mini); width: auto; min-width: 100px;"></div>
                <div id="dealer-score" class="score-badge" style="display:none; top: 50%; right: -25px;">0</div>
            </div>

            <!-- OPPONENT (Mini View) -->
            <div id="opponent-view" class="opponent-mini" style="display:none;">
                <div id="opp-name" class="opponent-name">Adversaire</div>
                <div id="opp-hand" class="opponent-cards-row"></div>
                <div id="opp-score" style="position:absolute; bottom:-8px; right:-5px; background:#444; color:white; font-size:0.6rem; padding:1px 5px; border-radius:4px; border:1px solid #777;">0</div>
            </div>
        </div>

        <!-- CENTER MESSAGE (MOVED UP) -->
        <div id="status-toast">MESSAGE</div>

        <!-- BOTTOM: HERO PLAYER -->
        <div class="hero-player">
            <!-- Bet moved UP -->
            <div class="bet-display" id="my-bet-display"></div>

            <!-- Cards Container fixed with flex-direction: row -->
            <div class="hero-cards-container" id="my-hand-container">
                <!-- Cards injected here -->
            </div>

            <div class="hero-info">
                <span id="my-name" style="color:#aaa;">Moi</span>
                <span style="color:#444; margin: 0 10px;">|</span>
                <span class="hero-bank">$<span id="my-bank">0</span></span>
            </div>
        </div>

        <!-- CHIPS DRAWER -->
        <div id="chip-drawer" class="betting-overlay">
            <div class="chip" style="background:#222; font-size:1.5rem; color:var(--danger); border-color:var(--danger);" onclick="placeBet(-1)">×</div>
            <div class="chip chip-10" onclick="placeBet(10)">10</div>
            <div class="chip chip-50" onclick="placeBet(50)">50</div>
            <div class="chip chip-100" onclick="placeBet(100)">100</div>
            <div class="chip chip-500" onclick="placeBet(500)">500</div>
            <div class="chip" style="background:var(--gold); border-color:white; color:black;" onclick="validateBet()">GO</div>
        </div>

        <!-- CONTROLS -->
        <div class="controls-bar">
            <button id="btn-hit" class="ctrl-btn btn-hit" onclick="clientAction('HIT')">TIRE</button>
            <button id="btn-stand" class="ctrl-btn btn-stand" onclick="clientAction('STAND')">RESTE</button>
            <button id="btn-double" class="ctrl-btn btn-double" onclick="clientAction('DOUBLE')">DOUBLE</button>
            <button id="btn-split" class="ctrl-btn btn-split" onclick="clientAction('SPLIT')">SPLIT</button>
            
            <!-- Host Button -->
            <button id="btn-deal" class="ctrl-btn btn-deal" style="display:none;" onclick="hostDeal()">DISTRIBUER</button>
            <button id="btn-open" class="ctrl-btn btn-deal" style="display:none;" onclick="hostOpenTable()">OUVRIR LA TABLE</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const SUITS = ['♠', '♥', '♣', '♦'];
        const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        
        const peerConfig = {
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] }
        };

        let peer, hostConn, playerConnections = [null, null];
        let myRole = null, mySeatIndex = -1;
        let localBetDraft = 0;

        let gameState = {
            phase: 'lobby',
            activePlayerIndex: 0,
            activeHandSubIndex: 0,
            deck: [],
            dealer: { hand: [], score: 0 },
            players: [
                { id: null, name: null, hand: [], score: 0, bankroll: 0, bet: 0, status: 'empty', splitHand: null, splitScore:0, splitBet:0 },
                { id: null, name: null, hand: [], score: 0, bankroll: 0, bet: 0, status: 'empty', splitHand: null, splitScore:0, splitBet:0 }
            ]
        };

        // --- DOM REFS ---
        const ui = {
            login: document.getElementById('login-overlay'),
            table: document.getElementById('game-table'),
            status: document.getElementById('status-toast'),
            chips: document.getElementById('chip-drawer'),
            dealerHand: document.getElementById('dealer-hand'),
            myHand: document.getElementById('my-hand-container'),
            oppView: document.getElementById('opponent-view'),
            oppHand: document.getElementById('opp-hand'),
            btns: {
                hit: document.getElementById('btn-hit'),
                stand: document.getElementById('btn-stand'),
                double: document.getElementById('btn-double'),
                split: document.getElementById('btn-split'),
                deal: document.getElementById('btn-deal'),
                open: document.getElementById('btn-open')
            }
        };

        // --- CONNECTION LOGIC ---
        function initLogin() {
            const room = document.getElementById('room-input').value.trim();
            const user = document.getElementById('user-input').value.trim();
            const bank = parseInt(document.getElementById('bank-input').value) || 1000;
            if(!room || !user) return;

            const peerId = 'rbj_mobile_' + room.toLowerCase().replace(/[^a-z0-9]/g, '');
            document.getElementById('conn-log').innerText = "Connexion...";

            const p = new Peer(peerId, peerConfig);
            
            p.on('open', (id) => {
                myRole = 'HOST'; peer = p;
                startUI();
                setupHost();
            });
            p.on('error', (err) => {
                if(err.type === 'unavailable-id') joinClient(peerId, user, bank);
                else alert("Erreur: " + err.type);
            });
        }

        function joinClient(hostId, user, bank) {
            const p = new Peer(null, peerConfig);
            p.on('open', () => {
                myRole = 'CLIENT'; peer = p;
                hostConn = p.connect(hostId);
                hostConn.on('open', () => {
                    hostConn.send({ type: 'JOIN', name: user, bank: bank });
                    startUI();
                });
                hostConn.on('data', handleData);
                hostConn.on('close', () => location.reload());
            });
        }

        function startUI() {
            ui.login.style.display = 'none';
            ui.table.style.display = 'flex';
        }

        // --- HOST LOGIC ---
        function setupHost() {
            peer.on('connection', (conn) => {
                const idx = gameState.players.findIndex(p => p.status === 'empty');
                if(idx === -1) { setTimeout(() => conn.close(), 500); return; }

                conn.on('data', (data) => {
                    if(data.type === 'JOIN') {
                        gameState.players[idx] = { ...gameState.players[idx], id: conn.peer, name: data.name, bankroll: data.bank, status: 'joined' };
                        playerConnections[idx] = conn;
                        conn.send({ type: 'WELCOME', seat: idx });
                        broadcast();
                    }
                    if(data.type === 'BET' && gameState.phase === 'betting') {
                        gameState.players[idx].bet = data.amount;
                        gameState.players[idx].status = 'ready';
                        broadcast();
                    }
                    if(data.type === 'ACTION') handleAction(idx, data.act);
                });

                conn.on('close', () => {
                    gameState.players[idx] = { id:null, name:null, hand:[], score:0, bankroll:0, bet:0, status:'empty', splitHand:null };
                    playerConnections[idx] = null;
                    broadcast();
                });
            });
        }

        function hostOpenTable() {
            gameState.deck = createDeck();
            gameState.phase = 'betting';
            broadcast();
        }

        function hostDeal() {
            const active = gameState.players.filter(p => p.status !== 'empty');
            if(active.length > 0 && active.every(p => p.status === 'ready')) {
                gameState.players.forEach(p => {
                    if(p.status === 'ready') {
                        p.bankroll -= p.bet;
                        p.hand = [draw(), draw()];
                        p.score = calc(p.hand);
                        p.status = 'playing';
                        if(p.score === 21) p.status = 'blackjack';
                    }
                });
                gameState.dealer.hand = [draw(), draw()];
                gameState.dealer.score = calc(gameState.dealer.hand);
                
                gameState.phase = 'turn';
                gameState.activePlayerIndex = gameState.players.findIndex(p => p.status === 'playing');
                gameState.activeHandSubIndex = 0;
                
                if(gameState.activePlayerIndex === -1) { gameState.phase = 'dealer_turn'; runDealer(); }
                broadcast();
            }
        }

        function handleAction(idx, act) {
            if(gameState.phase !== 'turn' || gameState.activePlayerIndex !== idx) return;
            const p = gameState.players[idx];
            const isSplit = (gameState.activeHandSubIndex === 1);
            let hand = isSplit ? p.splitHand : p.hand;
            
            if(act === 'HIT') {
                hand.push(draw());
                if(isSplit) p.splitScore = calc(hand); else p.score = calc(hand);
                
                const sc = isSplit ? p.splitScore : p.score;
                if(sc > 21) {
                    if(isSplit) p.splitStatus = 'busted'; else p.status = 'busted'; 
                    advance();
                }
            } else if(act === 'STAND') {
                if(isSplit) p.splitStatus = 'stand'; else p.status = 'stand'; 
                advance();
            } else if(act === 'DOUBLE' && !isSplit && p.bankroll >= p.bet) {
                p.bankroll -= p.bet; p.bet *= 2;
                hand.push(draw());
                p.score = calc(hand);
                p.status = p.score > 21 ? 'busted' : 'stand';
                advance();
            } else if(act === 'SPLIT' && !isSplit && p.bankroll >= p.bet) {
                p.bankroll -= p.bet;
                p.splitBet = p.bet;
                p.splitHand = [p.hand.pop()];
                p.hand.push(draw());
                p.splitHand.push(draw());
                p.score = calc(p.hand);
                p.splitScore = calc(p.splitHand);
                p.splitStatus = 'playing';
            }
            broadcast();
        }

        function advance() {
            const p = gameState.players[gameState.activePlayerIndex];
            if(gameState.activeHandSubIndex === 0 && p.splitHand) {
                gameState.activeHandSubIndex = 1;
                return;
            }
            let next = -1;
            for(let i = gameState.activePlayerIndex + 1; i < 2; i++) {
                if(gameState.players[i].status === 'playing') { next = i; break; }
            }
            if(next !== -1) {
                gameState.activePlayerIndex = next;
                gameState.activeHandSubIndex = 0;
            } else {
                gameState.phase = 'dealer_turn';
                runDealer();
            }
        }

        function runDealer() {
            broadcast();
            const play = () => {
                if(gameState.dealer.score < 17) {
                    setTimeout(() => {
                        gameState.dealer.hand.push(draw());
                        gameState.dealer.score = calc(gameState.dealer.hand);
                        broadcast();
                        play();
                    }, 800);
                } else endRound();
            };
            setTimeout(play, 800);
        }

        function endRound() {
            gameState.phase = 'payout';
            const dSc = gameState.dealer.score > 21 ? 0 : gameState.dealer.score;
            
            gameState.players.forEach(p => {
                if(p.status === 'empty') return;
                const settle = (sc, bet, st) => {
                    let w = 0;
                    const cleanSc = sc > 21 ? 0 : sc;
                    if(st === 'blackjack') w = (gameState.dealer.hand.length===2 && dSc===21) ? bet : bet*2.5;
                    else if(st !== 'busted') {
                        if(cleanSc > dSc) w = bet*2;
                        else if(cleanSc === dSc) w = bet;
                    }
                    p.bankroll += w;
                };
                settle(p.score, p.bet, p.status);
                if(p.splitHand) settle(p.splitScore, p.splitBet, p.splitStatus);
            });
            broadcast();
            
            setTimeout(() => {
                gameState.phase = 'betting';
                gameState.players.forEach(p => {
                    if(p.status !== 'empty') {
                        p.hand = []; p.score=0; p.bet=0; p.status='joined'; p.splitHand=null;
                    }
                });
                gameState.dealer.hand = [];
                broadcast();
            }, 4000);
        }

        // --- CLIENT LOGIC ---
        function handleData(data) {
            if(data.type === 'WELCOME') mySeatIndex = data.seat;
            if(data.type === 'UPDATE') {
                gameState = data.state;
                if(gameState.phase === 'betting' && gameState.players[mySeatIndex].bet === 0) localBetDraft = 0;
                render();
            }
        }
        function clientAction(act) { hostConn.send({ type: 'ACTION', act: act }); }
        function placeBet(amt) {
            const p = gameState.players[mySeatIndex];
            if(amt === -1) localBetDraft = 0;
            else if(localBetDraft + amt <= p.bankroll) localBetDraft += amt;
            render();
        }
        function validateBet() {
            if(localBetDraft > 0) hostConn.send({ type: 'BET', amount: localBetDraft });
        }

        // --- SHARED ---
        function broadcast() {
            playerConnections.forEach(c => { if(c && c.open) c.send({ type: 'UPDATE', state: gameState }); });
            render();
        }
        function createDeck() {
            let d = [];
            SUITS.forEach(s => RANKS.forEach(r => d.push({r, s, val: (r==='A'?11 : (['J','Q','K'].includes(r)?10:parseInt(r))), color: (s==='♥'||s==='♦')?'red':'black' })));
            return d.sort(()=>Math.random()-0.5);
        }
        function draw() { return gameState.deck.pop(); }
        function calc(h) {
            let s=0, a=0; h.forEach(c=>{s+=c.val; if(c.r==='A')a++});
            while(s>21 && a>0){s-=10;a--} return s;
        }

        // --- RENDERER (THE MAGIC) ---
        function render() {
            // Toast Status
            const toast = ui.status;
            let msg = "";
            if(gameState.phase === 'lobby') msg = "EN ATTENTE";
            if(gameState.phase === 'betting') msg = "FAITES VOS JEUX";
            if(gameState.phase === 'payout') msg = "RÉSULTATS";
            if(gameState.phase === 'turn') {
                const activeP = gameState.players[gameState.activePlayerIndex];
                if(gameState.activePlayerIndex === mySeatIndex) msg = "À TOI DE JOUER";
                else msg = `TOUR DE ${activeP.name}`;
            }
            if(msg) { toast.innerText = msg; toast.classList.add('visible'); }
            else toast.classList.remove('visible');

            // --- DEALER ---
            ui.dealerHand.innerHTML = '';
            gameState.dealer.hand.forEach((c, i) => {
                const hidden = (i===1 && (gameState.phase==='turn' || gameState.phase==='betting'));
                ui.dealerHand.appendChild(createCard(c, i, hidden, false));
            });
            document.getElementById('dealer-score').style.display = (gameState.dealer.hand.length > 0 && gameState.phase !== 'betting') ? 'block' : 'none';
            document.getElementById('dealer-score').innerText = gameState.dealer.score;

            // --- IDENTIFY ROLES ---
            let me = null, opp = null;
            if(myRole === 'CLIENT') {
                me = gameState.players[mySeatIndex];
                opp = gameState.players[mySeatIndex === 0 ? 1 : 0];
            } else {
                me = gameState.players[0];
                opp = gameState.players[1];
            }

            // --- MY HERO AREA ---
            ui.myHand.innerHTML = '';
            document.getElementById('my-name').innerText = me.name || 'Vide';
            document.getElementById('my-bank').innerText = me.bankroll;
            
            // Chips Drawer
            if(gameState.phase === 'betting' && me.status !== 'ready' && (myRole === 'CLIENT')) {
                ui.chips.classList.add('show');
                document.getElementById('my-bet-display').innerText = localBetDraft > 0 ? `$${localBetDraft}` : "MISE ?";
            } else {
                ui.chips.classList.remove('show');
                let displayBet = me.bet;
                if(me.splitBet > 0) displayBet += me.splitBet;
                document.getElementById('my-bet-display').innerText = displayBet > 0 ? `$${displayBet}` : "";
            }

            // Cards Main
            const myTurn = (gameState.phase === 'turn' && gameState.activePlayerIndex === (myRole==='CLIENT'?mySeatIndex:0));
            
            // Helper wrapper for Main Hand
            const wrap = document.createElement('div');
            // Important : on n'utilise plus de classe générique mais un style inline pour forcer le layout horizontal
            wrap.className = `hero-cards-container ${me.splitHand ? 'split-mode' : ''}`;
            
            // Score Bubble
            if(me.hand.length>0) {
                const sb = document.createElement('div');
                sb.className = 'score-badge'; sb.innerText = me.score;
                wrap.appendChild(sb);
            }
            me.hand.forEach((c, i) => wrap.appendChild(createCard(c, i, false, true)));
            ui.myHand.appendChild(wrap);

            // Split Hand (si existe)
            if(me.splitHand) {
                const wrapS = document.createElement('div');
                wrapS.className = 'hero-cards-container split-mode';
                if(myTurn && gameState.activeHandSubIndex === 1) wrapS.style.transform = "scale(1.1)"; 
                
                const sbS = document.createElement('div');
                sbS.className = 'score-badge'; sbS.innerText = me.splitScore;
                wrapS.appendChild(sbS);

                me.splitHand.forEach((c, i) => wrapS.appendChild(createCard(c, i, false, true)));
                ui.myHand.appendChild(wrapS);
            }

            // --- OPPONENT MINI ---
            ui.oppView.style.display = (opp && opp.status !== 'empty') ? 'flex' : 'none';
            if(opp && opp.status !== 'empty') {
                document.getElementById('opp-name').innerText = opp.name;
                ui.oppHand.innerHTML = '';
                opp.hand.forEach((c, i) => ui.oppHand.appendChild(createCard(c, i, false, false)));
                document.getElementById('opp-score').innerText = opp.score;
            }

            // --- CONTROLS ---
            Object.values(ui.btns).forEach(b => { b.style.display = 'none'; b.classList.remove('active'); });
            
            if(myRole === 'HOST') {
                ui.btns.open.style.display = 'block';
                ui.btns.deal.style.display = 'block';
                if(gameState.phase === 'lobby') ui.btns.open.classList.add('active');
                if(gameState.phase === 'betting') {
                   const activeP = gameState.players.filter(p=>p.status!=='empty');
                   if(activeP.length > 0 && activeP.every(p=>p.status==='ready')) ui.btns.deal.classList.add('active');
                }
            } else if (myRole === 'CLIENT' && myTurn) {
                ['hit', 'stand', 'double', 'split'].forEach(k => { ui.btns[k].style.display = 'block'; ui.btns[k].classList.add('active'); });
                
                const activeH = (gameState.activeHandSubIndex === 0) ? me.hand : me.splitHand;
                const activeBet = (gameState.activeHandSubIndex === 0) ? me.bet : me.splitBet;

                if(activeH.length !== 2 || me.bankroll < activeBet) ui.btns.double.classList.remove('active');
                if(gameState.activeHandSubIndex !== 0 || me.hand.length !== 2 || me.hand[0].r !== me.hand[1].r || me.splitHand || me.bankroll < me.bet) ui.btns.split.classList.remove('active');
            }
        }

        function createCard(c, i, hidden, big) {
            const el = document.createElement('div');
            el.className = `card ${c.color} ${hidden ? 'back' : ''}`;
            if(big && !hidden) {
                el.innerHTML = `
                    <div style="font-size:1em; line-height:1;">${c.r}<br>${c.s}</div>
                    <div class="suit-center">${c.s}</div>
                    <div class="val-btm" style="font-size:1em; line-height:1;">${c.r}<br>${c.s}</div>
                `;
            } else if(!hidden) {
                el.innerHTML = `${c.r}${c.s}`;
            }
            return el;
        }

    </script>
</body>
</html>